[00:14] **deathgripson**: Atomic Swap Team presenting to you the ErgoHack Ergo-Bitcoin Lightning Atomic Swaps project.

[00:26] **deathgripson**: For this hackathon, we have some pretty simple goals laid out. We want to establish a Bitcoin testnet environment. We want to also establish a testnet lightning environment. We're using the lightning implementation called LND.

[00:44] **deathgripson**: We want to modify our existing ErgoScript atomic swap contract. And also, we're going to use SHA-256 pre-images instead of curve points in that contract. We're also going to execute a proof of concept swap using native lightning invoice pre-images as the secret for our atomic swap.

[01:13] **deathgripson**: So we established our Bitcoin testnet environment by following a tutorial by a guy named Bitstein. We updated the instructions in the tutorial and saved the updates in a GitHub called Bitcoin Regtest Tooling. So it's all updated for the latest releases for Bitcoin and Lightning.

[01:40] **deathgripson**: Bitcoin Regtest Tooling has a lot of helper scripts for installing Bitcoin and LND nodes. Makes it easy to send funds to them, establish channels for them, and all sorts of things that you might need to do. We're also going to use the tooling environment to help us integrate it into our software later.

[02:07] **deathgripson**: For this implementation, we need hash pre-images, which are natively used already in the Lightning Network, which makes it very convenient. It reduces the complexity on development from both the Bitcoin and Ergo sides.

[02:25] **deathgripson**: We already have an existing atomic swap contract used for point-based swaps, also known as PTLCs, in comparison with HTLCs, which are hash-based swaps. The contract is used with the Sepolia EVM testnet. The only modifications we need to make are, instead of checking curve points, we're going to be checking a hash preimage.

[02:52] **deathgripson**: So ErgoScript gives us a lot of access to what we need to accomplish this already. In this case, we have a SHA-256 function and a from base 16 function. And today we're going to demonstrate the proof of concept swap in the command line between the testnet Ergo and regtest lightning.

[03:21] **deathgripson**: So what is a hash preimage? Also, why are we using it? So hash preimage at its most simple explanation is just the input to a hash function. SHA-256 is the hash function we're using today. So if you ran SHA-256 on the number one, the preimage would be one.

[03:43] **deathgripson**: How is this secure? Well, in order for it to be secure, the input needs to be sufficiently random. If the input was just one or another weak input, then it can be easily broken by something called a rainbow table attacks, which basically just guesses the input to the hash function. If it's weak enough, it can be easily computed by modern hardware.

[04:10] **deathgripson**: So why do we use it? Hash algorithms such as SHA-256 are built to be preimage attack resistant. Difficulty in cracking the preimage allowed it to be used as a secure secret in the atomic swap protocol. You can chalk this up to, it's very difficult for a computer to guess what the input to the preimage is. It's so difficult that it's safe to be used in time lock contracts where the time that it's expected to be locked up in is shorter than the time it would take to break it, which at this point for most computers the time it would take to break it is excessive.

[04:58] **deathgripson**: So where is this currently used? They're currently used in Bitcoin known as HTLCs or hash time lock contracts for lightning opening and closes and also other interactions as we're going to showcase in this demonstration today.

[05:17] **deathgripson**: So how does Lightning use hash preimages? So they use hash preimages in their invoices. An invoice is generated by the payee, the person receiving the payment, and it also automatically generates a SHA-256 preimage without the payee needing to do anything.

[05:38] **deathgripson**: The public part of the invoice is called a payment request, and it includes a bunch of information, including how much the payee expects in the invoice and the preimage. They can send this payment request to the payer. The payer can then verify how much money they're going to send and they can check what the preimage hash looks like. And if they agree, then they can pay the invoice.

[06:09] **deathgripson**: When they successfully pay the invoice to the other, to the payee's lightning node, the payer will receive the preimage generated in the first step by the payee. So this preimage, which was originally secret, is now handed off to the person who paid. Since it was implemented very generally, then it's allowed to be used as a secret in Atomic Swaps, basically.

[06:36] **deathgripson**: So how do we modify our ErgoScript implementation in order to get it to work with hashes instead of points? So we have to remove the curve generator variable because we won't be using it. We also remove the check for point-based elements, which are public group elements that help coordinate the swap in a point time lock contract swap.

[07:04] **deathgripson**: We have to replace getting the registers 4 through 7 because we only need register 4 and we'll get it as a collection of bytes and in the sigma prop at the end we just have to check that the SHA-256 of register 4 is equal to the from base 16 of the preimage hash string.

[07:30] **deathgripson**: And from base 16, all that basically does is takes a string, which is expected to be a hexadecimal string, and turn it into a collection of bytes, which is what the output of SHA-256 of R4 would be. So we could compare them.

[07:51] **deathgripson**: So in our proof of concept swap, the steps for getting it done are, first, we make a lightning invoice on one of the regtest notes. We send the payment request to the second note. Of course, the second note is me, so I can just copy and paste it.

[08:14] **deathgripson**: Since the payment request contains the preimage, basically in a real scenario, you could verify that the hash that it contains is the same hash that is on the ErgoScript contract that is also deployed in this step. So the person generating the preimage also deploys an ErgoScript contract that has the same hash to the preimage locking up the funds.

[08:42] **deathgripson**: So the receiver can now verify that this hash preimage is locking up the funds on both the lightning invoice and the ErgoScript preimage contract. Once verifying this and also the amount of funds expected in the invoice and the funds in the contract, they can decide to pay the invoice, at which point they will receive the preimage that is locking up the Ergo. So they can then claim the Ergo after receiving the preimage.

[09:24] **deathgripson**: Alright, now we're going to demonstrate the implementation of the Ergo lightning atomic swaps. We're going to start here with our testnet environment. So to start we're going to open up two lightning testnet nodes. We're going to do this by those directories. In this case it's LND and LND2. So first LND and then LND2.

[10:00] **deathgripson**: So those are open now. We have to unlock them with unlock LND the same way.

[10:19] **deathgripson**: Okay, next we're going to generate some blocks just to be safe, because sometimes it will not work properly if you don't do that. So we generated five blocks. Reminder, this is Regtest Bitcoin, which makes testing very easy for local environments.

[10:45] **deathgripson**: So the next thing we have to do is generate an invoice. So we're gonna generate an invoice, I believe on Lightning Network node one. So invoice on D. And we're gonna pick an amount. We're gonna pick a thousand Satoshis.

[11:03] **deathgripson**: So now we've got our hash. This is the hash of our preimage. We've got our payment address and a payment request. So this is what we'll send to the node 2.

[11:36] **deathgripson**: For now, we're gonna grab this hash and what node one is gonna do, or directory LND is gonna do, is going to deploy an ErgoScript contract. So here we have our Ergo IDE. We can paste in the hash here in the preimage hash variable. And what that does here is, allows for the script that's uploaded to compare the SHA-256 with the preimage bytes to that preimage hash and allows it to be compared for locking the Ergo for claiming it.

[12:24] **deathgripson**: So, we can deploy this contract.

[12:39] **deathgripson**: All right, so now the contract is deployed. We should be able to pull up on the Explorer here.

[12:56] **deathgripson**: So here it's unconfirmed right now. We can look at it. So now it should be confirmed. So here's our script. You can see there's a SHA-256. And then I'm checking against this placeholder here.

[13:28] **deathgripson**: So now that the contract is deployed, the second node can see that the contract is deployed. They can verify the hash here because the hash will now be this preimage hash value. And they can go ahead and pay the invoice here. We'll say yes to pay the invoice.

[13:58] **deathgripson**: Now we're going to just copy the preimage. We're going to go back to our IDE.

[14:18] **deathgripson**: There we go. So what we're also going to do is we're going to go to our config over here, and we have to make sure to target the right box. So this box ID right here. And now, lastly, what we'll want to do is we want to run receiver claim instead of deposit. And we should be able to claim from this box here.

[14:52] **deathgripson**: So, run that.

[15:01] **deathgripson**: There we go, that was successful. If we open this up.

[15:18] **deathgripson**: So now we can see here that this is spending from this box here, which is basically the pre-image atomic swap box. And on the lightning side, you can see obviously that this was a succeeded payment. So node one receives the lightning and node two claims from the Ergo contract.

[15:46] **deathgripson**: Maybe this is confirmed. There we go, two confirmations. And you can see again, this is the new ErgoTree script with the, we're using again the SHA-256 check right here.

[16:09] **deathgripson**: Thanks for watching and listening to my Ergo Hackathon project presentation this year. I hope you found some of it interesting. I hope everyone had a fun ErgoHack who participated this year. To stay updated on the Atomic Swap project that I'm working on, you can join our Atomic Analog Swap Discord or join the Ergo Discord. We'll be posting frequently in both of there.

[16:30] **deathgripson**: We're planning on launching a public testnet soon. So yeah, anyone who wants to participate in the public testnet will be able to do so very, very soon. And we're always looking for new ideas and contributions to the project. So yeah, thank you for listening.